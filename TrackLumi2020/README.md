# 2020 track luminosity studies

This directory contains the scripts and results for the track luminosity studies I did in 2020, based on the original code developed in 2016.

The basic script for making the track luminosity is the same, `TrackLumiZeroCounting`. For these studies I have modified it so that it uses a cut of sigma < 2.0, to ensure that the contribution from accidentals is minimized, but otherwise it's basically the same as what we developed in 2016. See the documentation in `TrackLumiZC` for details on this script.

However, there are a number of improvements made. In particular, the scripts for plotting the track lumi data against the online luminometers have been significantly improved, so they can use data from `brilcalc` rather than having to go through the rather cumbersome process of pulling data from the CondDB. This greatly simplifies the procedure for running on the 2016 data, as follows:

* Run `make_fill.py` with two arguments: the fill number, and the Slink data file name. This will automatically invoke `brilcalc` to get the luminosity (in the correct format), using the current 2016 paper normtags for hfoc and pltzero (`hfoc16PaperV3` and `pltzero16PaperV2`, respectively). Then, it will run `TrackLumiZeroCounting` with the correct gain calibration, alignment, and track distributions for the 2016 data and save the resulting file. (Obviously, you can update this for other years as appropriate.)

* To plot the results from a single fill, use `PlotTrackLumiFill.C`. This script takes an argument (the fill number), so to run it within ROOT, use something like `.x PlotTrackLumiFill.C(5340)`. Or you can run it from the command line in batch mode (useful if you want to run multiple fills) with `root -b -q PlotTrackLumiFill.C\(5340\)`. This will make three separate plots:
  * `TrackLumiVsTime_5340_fix.png` will contain the luminosity as a function of time for the track lumi, alongside hfoc and pltzero for comparison. Note that the script automatically scales the track luminosity to match the hfoc luminosity.
  * `TrackLumiRatiosVsTime_5340_fix.png` will contain the ratios for track/HFOC and track/PLTZ as a function of time.
  * `TrackLumiRatiosVsSBIL_5340_fix.png` will contain the ratios, but as a function of SBIL instead. They are fitted with a linear fit to determine the resulting nonlinearity of the track measurement with respect to hfoc/pltzero.

  By default, the script will attempt to automatically detect and fix cases where the pixel data for one of the PLT channels drops out or is otherwise bad (hence the `_fix` in the file name). If you want to disable this automatic fixing (if it's not working well or if you just want to see how bad the results look without it), set `attemptChannelFix` to `false` at the top of the script. Also, `TrackLumiZeroCounting` attempts to automatically determine the number of filled bunches; however, sometimes this determination fails. To override the automatically determined value, set the fill and correct number of bunches in the `nbx` map. Finally, if you want to run this script on a different year than 2016, make sure to update `nPixelChannels` to match the number of channels written out by `TrackLumiZeroCounting` (you will also have to update `TrackLumiZeroCounting` to actually write out the correct channels as well).

  Note that when making linearity plots, the script will automatically ignore any ratios outside the range [0.95, 1.05] so that weird outliers don't mess up the fit. The channel dropout detection algorithm uses the ratios of each channel's track rate to the overall track rate, and will mark a channel as bad (and exclude it from the luminosity measurement for the rest of the fill) if that ratio changes by more than 10%.

* To plot the results for a series of fills and look at the long-term stability and linearity, use `StabilityLinearity.C`. This basically runs the same procedure as above and makes two plots:
  * `RatioVsTimeLongterm_fix.png` is the ratio over time for the lumisections from all fills together.
  * `LinearityVsFill_fix.png` is the fitted slope as a function of SBIL on a fill-by-fill basis.

  Like `PlotTrackLumiFill.C`, you can set `attemptChannelFix`, `nbx`, and `nPixelChannels` as above. In addition, by default, the script will calibrate the track luminosity to HFOC on a fill-by-fill basis, which gives better agreement but is arguably less realistic; to disable this, set `constScaleFactor` to a (positive) constant value instead of `-1`. (This will add `_const` to your stability plot name. Note that this has no effect on the linearity plot, since that always uses the per-fill scale factor.) Also, the overall list of fills should be set in `fills`.

These two scripts have a fair amount of duplicated code -- arguably they should be refactored, but for now this is the setup.

Finally, the results included in this directory are the results of this study for 2016. For this study, I included 10 fills, 4958, 5013, 5052, 5109, 5183, 5261, 5282, 5340, 5394, and 5451. These fills were chosen to cover the entire year, be reasonably long (and thus have a good range of luminosity values), and have no known PLT operational issues (although as you can see many of them are affected by dropouts in the pixel data which did not affect the fast-or luminosity). 5005, which was the 2016 mu-scan fill, is also included, although it turns out that the resolution of the track-counting luminosity is insufficient for this to be a particularly useful fill to look at. The plots include the plots from `PlotTrackLumiFill.C` for each fill (in both fixed and unfixed versions) and the overall plots from `StabilityLinearity.C` for these ten fills. Finally, also included are the log files from `TrackLumiZeroCounting` for each fill, since these can contain useful information about the channel dropouts detected by that script.
